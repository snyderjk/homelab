---
# Play 1: Read admin.conf from control plane and store in hostvars
- name: Read kubeconfig from control plane
  hosts: control_plane
  become: true
  gather_facts: false

  tasks:
    - name: Read /etc/kubernetes/admin.conf from control plane
      slurp:
        src: /etc/kubernetes/admin.conf
      register: kcfg

    - name: Store kubeconfig content as a fact on control plane
      set_fact:
        kubeconfig_content: "{{ kcfg.content | b64decode }}"
        cacheable: false

# Play 2: Install kubeconfig for jason on all cluster nodes
- name: Install kubeconfig for {{ kube_user }} on all nodes
  hosts: k8s_cluster
  become: true
  gather_facts: false

  vars:
    kube_user: jason

  tasks:
    - name: Ensure .kube directory exists for {{ kube_user }}
      file:
        path: "/home/{{ kube_user }}/.kube"
        state: directory
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"
        mode: "0700"

    - name: Install kubeconfig for {{ kube_user }} on all nodes
      copy:
        dest: "/home/{{ kube_user }}/.kube/config"
        content: "{{ hostvars[groups['control_plane'][0]].kubeconfig_content }}"
        owner: "{{ kube_user }}"
        group: "{{ kube_user }}"
        mode: "0600"

# Play 3: Install kubeconfig for your toolbox/controller user
- name: Install kubeconfig on Ansible controller (toolbox)
  hosts: localhost
  gather_facts: false

  vars:
    local_kube_dir: "{{ lookup('env', 'HOME') + '/.kube' }}"
    local_kube_config: "{{ local_kube_dir + '/config' }}"

  tasks:
    - name: Ensure .kube directory exists on controller
      file:
        path: "{{ local_kube_dir }}"
        state: directory
        mode: "0700"

    - name: Install kubeconfig on controller
      copy:
        dest: "{{ local_kube_config }}"
        content: "{{ hostvars[groups['control_plane'][0]].kubeconfig_content }}"
        mode: "0600"

