- name: Join worker nodes to cluster
  hosts: workers, gpu_workers
  become: true
  gather_facts: false

  vars:
    control_plane_host: "{{ groups['control_plane'][0] }}"

  tasks:
    - name: Check if kubelet is already configured
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Get join command from control plane
      command: kubeadm token create --print-join-command
      delegate_to: "{{ control_plane_host }}"
      run_once: true
      register: join_cmd

    - name: Join node to cluster (only if not already joined)
      command: "{{ join_cmd.stdout }}"
      when: not kubelet_conf.stat.exists
      register: join_result
      changed_when: join_result.rc == 0
      failed_when: join_result.rc != 0

    - name: Display join output
      debug:
        msg: "Join result: {{ join_result.stdout }}"
      when: join_result is defined
