apiVersion: apps/v1
kind: Deployment
metadata:
  name: openclaw
  namespace: openclaw
  labels:
    app: openclaw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openclaw
  template:
    metadata:
      labels:
        app: openclaw
    spec:
      serviceAccountName: openclaw
      initContainers:
      - name: configure-trusted-proxy
        image: curlimages/curl:8.12.1
        command:
        - /bin/sh
        - -c
        - |
          CA=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
          APISERVER=https://kubernetes.default.svc
          RESP=$(curl -s --cacert "$CA" -H "Authorization: Bearer $TOKEN" \
            "$APISERVER/api/v1/namespaces/traefik/endpoints/traefik")
          TRAEFIK_IP=$(echo "$RESP" | grep -o '"ip": *"[0-9.]*"' | head -1 | grep -o '[0-9.]*')
          if [ -z "$TRAEFIK_IP" ]; then
            echo "WARN: Could not resolve Traefik pod IP, skipping trustedProxies update"
            echo "API response: $RESP"
            exit 0
          fi
          echo "Resolved Traefik pod IP: $TRAEFIK_IP"
          CONFIG="/home/node/.openclaw/openclaw.json"
          if [ ! -f "$CONFIG" ]; then
            echo '{}' > "$CONFIG"
          fi
          if grep -q '"trustedProxies"' "$CONFIG"; then
            sed -i "s|\"trustedProxies\": \[.*\]|\"trustedProxies\": [\"$TRAEFIK_IP\"]|" "$CONFIG"
          else
            sed -i "s|\"gateway\": {|\"gateway\": {\n    \"trustedProxies\": [\"$TRAEFIK_IP\"],|" "$CONFIG"
          fi
          echo "Updated trustedProxies to $TRAEFIK_IP"
          cat "$CONFIG"
        volumeMounts:
        - mountPath: /home/node/.openclaw
          name: openclaw-data
      containers:
      - name: openclaw
        image: ghcr.io/openclaw/openclaw:2026.2.9
        command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]
        workingDir: /app
        ports:
        - containerPort: 18789
          protocol: TCP
        env:
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: openclaw-api-keys
              key: ANTHROPIC_API_KEY
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: openclaw-api-keys
              key: OPENAI_API_KEY
        - name: OPENCLAW_GATEWAY_TOKEN
          valueFrom:
            secretKeyRef:
              name: openclaw-gateway-token
              key: OPENCLAW_GATEWAY_TOKEN
        - name: TELEGRAM_BOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: openclaw-telegram-token
              key: TELEGRAM_BOT_TOKEN
        - name: BROWSER_CDP_URL
          value: "http://localhost:9222"
        volumeMounts:
        - mountPath: /home/node/.openclaw
          name: openclaw-data
        - mountPath: /tmp
          name: tmp
      - name: sidecar
        image: ghcr.io/openclaw/openclaw:2026.2.9
        command:
        - /bin/sh
        - -c
        - |
          echo "Sidecar started, waiting for gateway..."
          sleep 15
          # Warm up all non-default agents so they appear in the web UI dropdown.
          # Uses --timeout 30 and --thinking off to keep it lightweight.
          echo "Warming up agent sessions..."
          for AGENT_ID in $(node -e "
            const c = require('/home/node/.openclaw/openclaw.json');
            (c.agents?.list || []).filter(a => a.id !== 'main').forEach(a => console.log(a.id));
          " 2>/dev/null); do
            echo "Pinging agent: $AGENT_ID"
            timeout 60 node dist/index.js agent --agent "$AGENT_ID" \
              --message "startup ping â€” respond in one word" \
              --thinking off --timeout 30 2>&1 | tail -1 || true
          done
          echo "Agent warm-up complete, entering pairing watch loop..."
          # Auto-approve pending device pairings
          while true; do
            PENDING="/home/node/.openclaw/devices/pending.json"
            if [ -f "$PENDING" ] && [ "$(cat "$PENDING")" != "{}" ]; then
              for REQ_ID in $(node -e "
                const p = require('$PENDING');
                Object.values(p).forEach(r => console.log(r.requestId));
              " 2>/dev/null); do
                echo "Auto-approving device pairing request: $REQ_ID"
                node dist/index.js devices approve "$REQ_ID" 2>&1 || true
              done
            fi
            sleep 5
          done
        workingDir: /app
        env:
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: openclaw-api-keys
              key: ANTHROPIC_API_KEY
        - name: OPENCLAW_GATEWAY_TOKEN
          valueFrom:
            secretKeyRef:
              name: openclaw-gateway-token
              key: OPENCLAW_GATEWAY_TOKEN
        volumeMounts:
        - mountPath: /home/node/.openclaw
          name: openclaw-data
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
      - name: chromium
        image: zenika/alpine-chrome:124
        args:
        - "--headless"
        - "--disable-gpu"
        - "--no-sandbox"
        - "--disable-dev-shm-usage"
        - "--remote-debugging-address=0.0.0.0"
        - "--remote-debugging-port=9222"
        ports:
        - containerPort: 9222
          protocol: TCP
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: "1"
            memory: 1Gi
        livenessProbe:
          tcpSocket:
            port: 9222
          initialDelaySeconds: 10
          periodSeconds: 30
        readinessProbe:
          tcpSocket:
            port: 9222
          initialDelaySeconds: 5
          periodSeconds: 10
        volumeMounts:
        - mountPath: /tmp
          name: tmp
      restartPolicy: Always
      volumes:
      - name: openclaw-data
        persistentVolumeClaim:
          claimName: openclaw-data
      - name: tmp
        emptyDir:
          medium: Memory
